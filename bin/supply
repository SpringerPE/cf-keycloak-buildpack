#!/usr/bin/env bash
set -euo pipefail
# https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html

# Environment variables which are provided by the CF platform
BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))
# Set custom environment variables, configured in parameters.sh
source ${BUILDPACK_DIR}/parameters.sh

# The Keycloak version can be overridden by specifying the version number in runtime.txt
# You can add comments to the runtime.txt when the line starts with `#`
if [ -f "${BUILD_DIR}/runtime.txt" ]
then
    KEYCLOAK_VERSION=$((grep -v '^#' "${BUILD_DIR}/runtime.txt" || true) | head -n1)
    if [ -z "${KEYCLOAK_VERSION}" ]
    then
        echo "ERROR> runtime.txt found but no version specified!"
        exit 1
    fi
fi

####################
# Download section #
####################

# This is where all required software is downloaded. All downloads are stored in a temporary location, which is the 'CACHE_DIR'. 

KEYCLOAK_DOWNLOAD_URL="https://downloads.jboss.org/keycloak/${KEYCLOAK_VERSION}/keycloak-${KEYCLOAK_VERSION}.tar.gz"
if [ -f "${CACHE_DIR}/keycloak-${KEYCLOAK_VERSION}.tar.gz" ]
then
    echo "-----> Using keycloak ${KEYCLOAK_VERSION} from cache"
else
    echo "-----> Downloading keycloak: ${KEYCLOAK_DOWNLOAD_URL}"
    if ! wget -nv "${KEYCLOAK_DOWNLOAD_URL}" -O "${CACHE_DIR}/keycloak-${KEYCLOAK_VERSION}.tar.gz" 2>&1 | sed 's/^/       /'
    then
        echo "ERROR> keycloak version ${KEYCLOAK_VERSION} not found, URL=${KEYCLOAK_DOWNLOAD_URL}"
        exit 1
    fi
fi

JDK_DOWNLOAD_URL="https://download.java.net/openjdk/jdk11/ri/openjdk-${OPENJDK_VERSION}_linux-x64_bin.tar.gz"
if [ -f "${CACHE_DIR}/openjdk-${OPENJDK_VERSION}.tar.gz" ]
then
    echo "-----> Using openjdk ${OPENJDK_VERSION} from cache"
else
    echo "-----> Downloading openjdk: ${JDK_DOWNLOAD_URL}"
    if ! wget -nv "${JDK_DOWNLOAD_URL}" -O "${CACHE_DIR}/openjdk-${OPENJDK_VERSION}.tar.gz" 2>&1 | sed 's/^/       /'
    then
        echo "ERROR> openjdk version ${OPENJDK_VERSION} not found, URL=${JDK_DOWNLOAD_URL}"
        exit 1
    fi
fi

MYSQL_DRIVER_DOWNLOAD_URL="https://repo1.maven.org/maven2/mysql/mysql-connector-java/$JDBC_MYSQL_VERSION/mysql-connector-java-$JDBC_MYSQL_VERSION.jar"
if [ -f "${CACHE_DIR}/mysql-connector-java-$JDBC_MYSQL_VERSION.jar" ]
then
    echo "-----> Using mysql driver ${JDBC_MYSQL_VERSION} from cache"
else
    echo "-----> Downloading mysql driver: ${MYSQL_DRIVER_DOWNLOAD_URL}"
    if ! wget -nv "${MYSQL_DRIVER_DOWNLOAD_URL}" -O "${CACHE_DIR}/mysql-connector-java-$JDBC_MYSQL_VERSION.jar" 2>&1 | sed 's/^/       /'
    then
        echo "ERROR> mysql driver version ${JDBC_MYSQL_VERSION} not found, URL=${MYSQL_DRIVER_DOWNLOAD_URL}"
        exit 1
    fi
fi