#!/usr/bin/env bash
set -euo pipefail
# https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html

BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

export BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))
source ${BUILDPACK_DIR}/parameters.sh

[ -f "${BUILD_DIR}/runtime.txt" ] && KEYCLOAK_VERSION=$(grep -v '^#' "${BUILD_DIR}/runtime.txt" | head -n1)


echo "-----> Installing keycloak"
mkdir -p "${KEYCLOAK_DIR}"

tar -zxf "${CACHE_DIR}/keycloak-${KEYCLOAK_VERSION}.tar.gz" -C "${KEYCLOAK_DIR}" --strip-components 1
chmod -R +x ${KEYCLOAK_DIR}/bin/*.sh

echo "-----> Installing openjdk"
mkdir -p "${OPENJDK_DIR}"

tar -zxf "${CACHE_DIR}/openjdk-${OPENJDK_VERSION}.tar.gz" -C "${OPENJDK_DIR}" --strip-components 1
chmod -R +x ${OPENJDK_DIR}/bin/*

export JAVA_HOME="${OPENJDK_DIR}"
# export JAVA_OPTS="-Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc)"

###
cd "${KEYCLOAK_DIR}"

echo ">Running standalone-configuration"
bin/jboss-cli.sh --file=${BUILDPACK_DIR}/cli/standalone-configuration.cli
rm -rf ${KEYCLOAK_DIR}/standalone/configuration/standalone_xml_history

echo ">Running standalone-ha-configuration"
bin/jboss-cli.sh --file=${BUILDPACK_DIR}/cli/standalone-ha-configuration.cli
rm -rf ${KEYCLOAK_DIR}/standalone/configuration/standalone_xml_history

###

mkdir -p "$BUILD_DIR/.profile.d"
cat <<EOF > "$BUILD_DIR/.profile.d/0010_keycloak.sh"
export TMPDIR=/home/vcap/tmp

export KEYCLOAK_VERSION=${KEYCLOAK_VERSION}
export KEYCLOAK_DIR="/home/vcap/deps/${DEPS_IDX}/keycloak"

export JAVA_HOME="/home/vcap/deps/${DEPS_IDX}/jdk"
EOF
