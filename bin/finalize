#!/usr/bin/env bash
set -euo pipefail
# https://docs.cloudfoundry.org/buildpacks/understand-buildpacks.html

BUILD_DIR="${1}"
CACHE_DIR="${2}"
DEPS_DIR="${3}"
DEPS_IDX="${4}"

BUILDPACK_DIR=$(dirname $(readlink -f ${BASH_SOURCE%/*}))
source ${BUILDPACK_DIR}/parameters.sh

[ -f "${BUILD_DIR}/runtime.txt" ] && KEYCLOAK_VERSION=$(grep -v '^#' "${BUILD_DIR}/runtime.txt" | head -n1)


echo "-----> Installing keycloak"
mkdir -p "${KEYCLOAK_DIR}"

tar -zxf "${CACHE_DIR}/keycloak-${KEYCLOAK_VERSION}.tar.gz" -C "${KEYCLOAK_DIR}" --strip-components 1
chmod -R +x ${KEYCLOAK_DIR}/bin/*.sh


###

export JAVA_HOME=$BUILD_DIR/.java-buildpack/open_jdk_jre
export JAVA_OPTS=-Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc) -Djava.ext.dirs=$BUILD_DIR/.java-buildpack/container_security_provider:$BUILD_DIR/.java-buildpack/open_jdk_jre/lib/ext -Djava.security.properties=$BUILD_DIR/.java-buildpack/java_security/java.security"
cd "${KEYCLOAK_DIR}"

bin/jboss-cli.sh --file=${BUILDPACK_DIR}/cli/standalone-configuration.cli
rm -rf ${KEYCLOAK_DIR}/standalone/configuration/standalone_xml_history

bin/jboss-cli.sh --file=${BUILDPACK_DIR}/cli/standalone-ha-configuration.cli
rm -rf ${KEYCLOAK_DIR}/standalone/configuration/standalone_xml_history

###

mkdir -p "$BUILD_DIR/.profile.d"
cat <<EOF > "$BUILD_DIR/.profile.d/0010_keycloak.sh"
export TMPDIR=/home/vcap/tmp

export KEYCLOAK_VERSION=${KEYCLOAK_VERSION}
export KEYCLOAK_DIR="${KEYCLOAK_DIR}"

export JAVA_HOME=$BUILD_DIR/.java-buildpack/open_jdk_jre
export JAVA_OPTS=-Djava.io.tmpdir=$TMPDIR -XX:ActiveProcessorCount=$(nproc) -Djava.ext.dirs=$BUILD_DIR/.java-buildpack/container_security_provider:$BUILD_DIR/.java-buildpack/open_jdk_jre/lib/ext -Djava.security.properties=$BUILD_DIR/.java-buildpack/java_security/java.security"
EOF

